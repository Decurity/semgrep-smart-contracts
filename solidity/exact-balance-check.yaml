rules:
 -
    id: exact-balance-check
    message: Testing the balance of an account as a basis for some action has risks
      associated with unexpected receipt of ether or another token, including
      tokens deliberately transfered to cause such tests to fail, as an MEV
      attack.
    metadata:
      category: logic
      references:
        - https://entethalliance.org/specs/ethtrust-sl/v1/#req-1-exact-balance-check
    mode: taint
    pattern-sinks:
      - patterns:
         - pattern: ... == ...
         - pattern-inside: require(...)
    pattern-sources:
      - pattern-either:
          - pattern: $T.balanceOf($A)
          - pattern: $T.balance
    languages:
      - solidity
    severity: ERROR

 -
    id: exact-balance-check-no-taint
    message: Testing the balance of an account as a basis for some action has risks
      associated with unexpected receipt of ether or another token, including
      tokens deliberately transfered to cause such tests to fail, as an MEV
      attack.
    metadata:
      category: logic
      references:
        - https://entethalliance.org/specs/ethtrust-sl/v1/#req-1-exact-balance-check
    patterns:
      - pattern-either:
         - pattern: |
            if (<... $T.balance == ... ...>) {
               ...
            }
         - pattern: |
            if (<... ... == $T.balance ...>) {
               ...
            }
         - pattern: |
            if (<... $T.balanceOf($A) == ... ...>) {
               ...
            }
         - pattern: |
            if (<... ... == $T.balanceOf($A) ...>) {
               ...
            }
         # init
         - pattern: |
            $X = $T.balance;
            ...
            if (<... ... == $X ...>) {
               ...
            }
         - pattern: |
            $X = $T.balance;
            ...
            if (<... $X == ... ...>) {
               ...
            }
         - pattern: |
            $X = $T.balanceOf($A);
            ...
            if (<... ... == $X ...>) {
               ...
            }
         - pattern: |
            $X = $T.balanceOf($A);
            ...
            if (<... $X == ... ...>) {
               ...
            }
         # bool init
         - pattern: |
            $X = <... $T.balance == ... ...>;
            ...
            if (<... $X ...>) {
               ...
            }
         - pattern: |
            $X = <... ... == $T.balance ...>;
            ...
            if (<... $X ...>) {
               ...
            }
         - pattern: |
            $X = <... $T.balanceOf($A) == ... ...>;
            ...
            if (<... $X ...>) {
               ...
            }
         - pattern: |
            $X = <... ... == $T.balanceOf($A) ...>;
            ...
            if (<... $X ...>) {
               ...
            }
    languages:
      - solidity
    severity: ERROR
