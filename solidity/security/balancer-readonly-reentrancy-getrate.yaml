rules:
  - id: balancer-readonly-reentrancy-getrate
    message: Use VaultReentrancyLib to protect from readonly reentrancy.
    metadata: 
      references: 
        - https://forum.balancer.fi/t/reentrancy-vulnerability-scope-expanded/4345
      category: security
      tags:
        - reentrancy
        - balancer
    patterns:
      - pattern: |
          $VAR.getRate()
      - pattern-not-inside: |
          function $F(...) {
            ...
            VaultReentrancyLib.ensureNotInVaultContext(...);
            ...
          }
      - pattern-not-inside: |
          function _updateTokenRateCache(...) {
            ...
          }
      - pattern-not-inside: |
          contract PoolRecoveryHelper {
            ...
          }
      - pattern-not-inside: |
          contract ComposableStablePoolRates {
            ...
          }
      - pattern-not-inside: |
          contract WeightedPoolProtocolFees {
            ...
          }
    languages:
      - solidity
    severity: ERROR