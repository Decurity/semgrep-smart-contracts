rules:
  - id: accessible-selfdestruct
    severity: ERROR
    languages:
      - solidity
    message: SELFDESTRUCT target address can be overwritten by untrusted external caller
    metadata:
      category: security
      tags:
        - selfdestruct
      references: 
        - https://www.parity.io/blog/a-postmortem-on-the-parity-multi-sig-library-self-destruct/
    mode: taint
    pattern-sources:
      - patterns:
        - focus-metavariable:
            - $ADDR
        - pattern-either:
            - pattern: function $FUNC(..., address $ADDR, ...) external { ... }
            - pattern: function $FUNC(..., address $ADDR, ...) public { ... }
        - pattern-not: function $FUNC(...) $MODIFIER { ... }
        - pattern-not: function $FUNC(...) $MODIFIER(...) { ... }
        - pattern-not: |
            function $FUNC(...) {
              ...
              require(<... msg.sender ...>, ...);
              ...
            }
        - pattern-not: |
            function $FUNC(...) {
              ...
              require(<... _msgSender ...>, ...);
              ...
            }
        - pattern-not: |
            function $FUNC(...) {
              ...
              if (<... msg.sender ...>) {
                ...
              }
              ...
            }
        - pattern-not: |
            function $FUNC(...) {
              ...
              if (<... _msgSender ...>) {
                ...
              }
              ...
            }
        - pattern-not: |
            function $FUNC(...) {
              ...
              onlyOwner(...);
              ...
            }
        - pattern-not: |
            function $FUNC(...) {
              ...
              requireOwner(...);
              ...
            }
        - pattern-not: |
            function $FUNC(...) {
              ...
              _requireOwnership(...);
              ...
            }
        - pattern-not: |
            function $FUNC(...) {
              ...
              $C._enforceIsContractOwner(...);
              ...
            }
        - pattern-not: |
            function $FUNC(...) {
              ...
              $C._enforceOwner(...);
              ...
            }
        - pattern-not: |
            function $FUNC(...) {
              ...
              $C.enforceIsContractOwner(...);
              ...
            }
    pattern-sinks:
      - pattern: selfdestruct(...);